// ====================================================================== //
//				HiMECS Slave DSP Program
// ====================================================================== //
//	- Author: Taewan Kim (System Control Lab.)
//	- Copyright: Hyundai Heavy Industries Co., Ltd. 
// ====================================================================== //
//	- File: Slave_DSP_main.c
// ---------------------------------------------------------------------- //
//	- Description: 
//		Source file for Slave Operation Program 
// ---------------------------------------------------------------------- //
//	- Revision History -
// ---------------------------------------------------------------------- //
//		2011-04-19:	Draft
// ====================================================================== //



// ====================================================================== //
//	Includes
// ====================================================================== //
#include "Slave_DSP_main.h"
// ====================================================================== //



// ====================================================================== //
//	Macro
// ====================================================================== //

// ====================================================================== //



// ====================================================================== //
//	Global Variables
// ====================================================================== //
Uint32 Timer0TickCount = 0;	// Counter Timer0 ISR execution
Uint16 Main_LoopCount = 0;

// Memory BIT 
int mem_test_result1 = 0;
int mem_test_result2 = 0;
int mem_test_result3 = 0;
int mem_test_result4 = 0;

float Temperature = 0;
// ====================================================================== //



// ====================================================================== //
//	Function Declararion
// ====================================================================== //
void Slave_DSP_Init (void);
interrupt void Timer0_ISR(void);
// ====================================================================== //



// ====================================================================== //
//	Main Function
// ---------------------------------------------------------------------- //
void main (void)
{
	// ====================================================================== //
	//	Local Variables
	// ---------------------------------------------------------------------- //
	//struct ECAN_REGS ECanaShadow;
	// ====================================================================== //

	
	// ====================================================================== //
	//	Initialize Slave DSP
	// ---------------------------------------------------------------------- //
	Slave_DSP_Init();
	// ====================================================================== //
	

	// ====================================================================== //
	//	Infinite Loop
	// ---------------------------------------------------------------------- //

	// Memory BIT Error Count Reset.
	s_BIT_Info.Mem_BIT_Err_Count = 0;

	Printf("\n\r\n\r ===== Slave DSP Program Start ===== \n\r ");

	for(;;)
	{
		Main_LoopCount++;

		// ===================================================================== //
		//	Modbus Tx Data
		// --------------------------------------------------------------------- //
		Modbus_Tx();
		// ===================================================================== //
	}
	// ====================================================================== //
}
// ====================================================================== //




// ====================================================================== //
//	Functions
// ====================================================================== //


// ====================================================================== //
//	Function:	Timer0_ISR
//		- Interrupt Service Routine of Timer0 
//		- User can adjust Timer0 interupt frequency by editing 
//		  TIMER0_ISR_FREQUENCY macro in Slave_DSP_Parameter.h. 				
// ---------------------------------------------------------------------- //
interrupt void Timer0_ISR(void)
{
	// 100us Timer0 interrupt 
	Timer0TickCount++;


	// ====================================================================== //
	// Slave DSP Run LED Blink
	// ---------------------------------------------------------------------- //
	if (Timer0TickCount > 2500)
	{
		Timer0TickCount = 0;
		L_DSP_RUN_LED_Toggle();
	}
	// ====================================================================== //


	// ====================================================================== //
	// Find End of Modbus Rx Frame 
	// ---------------------------------------------------------------------- //
	if (s_Modbus_buffer.Rx_EOF_flag == OFF)
	{
		s_Modbus_buffer.Interval_Time_Tick++;
	}

	if (s_Modbus_buffer.Interval_Time_Tick > s_Modbus_buffer.Rx_Time_Limit)
	{
		s_Modbus_buffer.Rx_EOF_flag = ON;
		s_Modbus_buffer.Interval_Time_Tick = 0;
	}

	Modbus_Rx_Process();
	// ====================================================================== //

	// Timer0 Interrupt Acknowledge.
	PieCtrlRegs.PIEACK.bit.ACK1 = 1;
}
// ====================================================================== //




// ====================================================================== //
//	Function: Slave_DSP_Init
//		- Initialization Slave DSP
// ---------------------------------------------------------------------- //
void Slave_DSP_Init (void)
{
	// ====================================================================== //
	// Local Variables
	// ---------------------------------------------------------------------- //
	int i = 0;
	// ====================================================================== //
	
	// ====================================================================== //
	// Disable Global Interrupt
	// ---------------------------------------------------------------------- //
	DINT;
	IER = 0x0000;
	IFR = 0x0000;
	// ====================================================================== //

	// ====================================================================== //
	//	System Control Initialization
	// ---------------------------------------------------------------------- //
	// PLL, WatchDog, enable Peripheral Clock Initialization
	// DSP280x_SysCtrl.c
	//		1 Disables the watchdog
	//		2 Set the PLLCR for proper SYSCLKOUT frequency 
	//		3 Set the pre-scaler for the high and low frequency peripheral clocks
	//			( HISPCP = 0x0001 => High Peripheral clock = System Clock/2 
	//			  LOSPCP = 0x0002 => Low Peripheral clock = System Clock/4	)
	//		4 Enable the clocks to the peripherals
	// ---------------------------------------------------------------------- //
	InitSysCtrl();
	// ====================================================================== //
	

	// ====================================================================== //
	//	Initialize Interrupt
	// ---------------------------------------------------------------------- //
	InitPieCtrl();			// Initialize Peripheral Interrupt Expansion circuit
	InitPieVectTable();		// Pie Vector Table Re-allocation
	// ====================================================================== //

	
	// ====================================================================== //
	//	Interrupt and ISR setting
	// ---------------------------------------------------------------------- //
	EALLOW;
	// Timer0 ISR setting	
	PieVectTable.TINT0 = &Timer0_ISR;

	// Timer0 Interrupt vector setting
	PieCtrlRegs.PIEIER1.bit.INTx7 = 1;
	
	IER |= M_INT1;		// PIEIER1 Enable.
	EDIS;	
	// ====================================================================== //
	

	// ====================================================================== //
	//	Timer Initialization.
	// ---------------------------------------------------------------------- //
	InitCpuTimers(); 
	ConfigCpuTimer(&CpuTimer0, SYSTEM_FREQUENCY, (int)(1000000/TIMER0_ISR_FREQUENCY));
	StartCpuTimer0();
	// ====================================================================== //


	// ====================================================================== //
	// GPIO Initialization
	// ---------------------------------------------------------------------- //
	GPIO_Init();
	// ====================================================================== //


	// ====================================================================== //
	// External Interface Initialization
	// ---------------------------------------------------------------------- //
	External_Interface_Init();
	// ====================================================================== //

	
	// ====================================================================== //
	// I2C Initialization
	// ---------------------------------------------------------------------- //
	I2C_Init();
	// ====================================================================== //
	
	
	// ====================================================================== //
	// Debug COM Initialization
	// ---------------------------------------------------------------------- //
	Debug_SCI_Init(DEFAULT_SCI_C_BAUD);
	Debug_SCI_Interrupt_Init();
	// ====================================================================== //

	
	// ====================================================================== //
	// DI/DO Initialization
	// ---------------------------------------------------------------------- //
	Slave_DIO.DI.L1.all = 0x0000;
	Slave_DIO.DI.L2.all = 0x0000;
	Slave_DIO.DO.all = 0x0000;
	DI_Update();
	DO_Update();
	// ====================================================================== //
	

	
	// ====================================================================== //
	// McBSP Communication Initialization.
	// ---------------------------------------------------------------------- //
	McBSP_Init_SPI();
	// ====================================================================== //	
	

	
	// ====================================================================== //
	// ADC and DAC Initialization.
	// ---------------------------------------------------------------------- //
	ADC_Init();
	// ====================================================================== //
	

	
	// ====================================================================== //
	// SPI Initialization.
	// ---------------------------------------------------------------------- //
	SPI_Init();
	// ====================================================================== //
	

	
	// ====================================================================== //
	// Thermocouple Initialization.
	// ---------------------------------------------------------------------- //
	Thermocouple_Init();
	// ====================================================================== //
	

	
	// ====================================================================== //
	// CAN Initialization.
	// ---------------------------------------------------------------------- //
	CAN_Init();
	CAN_A_Msg_Object_Setting();
	//CAN_B_Msg_Object_Setting();
	// ====================================================================== //
	
	
	// ====================================================================== //
	// Modbus Interrupt Initialization
	// ---------------------------------------------------------------------- //
	Modbus_Interrupt_Init();
	// ====================================================================== //


	// ====================================================================== //
	// Modbus Interrupt Initialization
	// ---------------------------------------------------------------------- //
	Modbus_Init();

	// Register Initialization
	for (i=0; i < MODBUS_REGISTER_SIZE; i++)
	{
		s_Modbus_buffer.Register[i] = 0;
	}
	// ====================================================================== //

	
	// ====================================================================== //
	// Enable global Interrupts and higher priority real-time debug events:
	// ---------------------------------------------------------------------- //
	EINT;   // Enable Global interrupt INTM
	ERTM;   // Enable Global realtime interrupt DBGM
	// ====================================================================== //
	
}
// ====================================================================== //




// ====================================================================== //
// End of file.
// ====================================================================== //


